# docker-compose.yml
services:
  firebase-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: "firebase_base_app"
    working_dir: /app
    stop_signal: SIGINT
    stop_grace_period: 30s
    ports:
      - "4000:4000"
      - "3000:3000"
      - "5001:5001"
      - "8080:8080"
      - "9099:9099"
      - "9299:9299"
      - "9150:9150"
      - "9005:9005"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - functions_node_modules:/app/functions/node_modules
      - ./emulator-data:/app/emulator-data
      - ./.firebase-credentials/config:/root/.config
      - ./.firebase-credentials/cache:/root/.cache
    command: /app/scripts/start-emulators.sh
    environment:
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - PUBLIC_FIREBASE_PROJECT_ID=${PUBLIC_FIREBASE_PROJECT_ID}
      - PUBLIC_FIREBASE_API_KEY=${PUBLIC_FIREBASE_API_KEY}
      - PUBLIC_FIREBASE_APP_ID=${PUBLIC_FIREBASE_APP_ID}
      - PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      - PUBLIC_FIREBASE_AUTH_DOMAIN=${PUBLIC_FIREBASE_AUTH_DOMAIN}
      - PUBLIC_FIREBASE_STORAGE_BUCKET=${PUBLIC_FIREBASE_STORAGE_BUCKET}
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - CHOKIDAR_INTERVAL=500
      # Ruolo utente per testing in DEV (superuser, admin, operatore)
      - DEV_USER_ROLE=${DEV_USER_ROLE}
  cypress-ui:
    build:
      context: .
      dockerfile: Dockerfile.cypress
    container_name: "cypress_ui"
    working_dir: /e2e
    depends_on:
      - firebase-cli
    # Usa network host per accedere direttamente a localhost
    network_mode: "host"
    environment:
      - CYPRESS_BASE_URL=http://localhost:3000
      - CYPRESS_FIREBASE_PROJECT_ID=${PUBLIC_FIREBASE_PROJECT_ID}
      - CYPRESS_FIREBASE_API_KEY=${PUBLIC_FIREBASE_API_KEY}
      - DISPLAY=:99
    volumes:
      - .:/e2e
      - cypress_node_modules:/e2e/node_modules

volumes:
  node_modules:
  functions_node_modules:
  cypress_node_modules:
